@using System.Collections.Generic
@using System.Text
@using System.Text.Json
@using Microsoft.Extensions.AI

@* Registry-compatible component for weather tool visualization *@
@* Supports both call-only (loading) and result (weather card) states *@

@if (IsLoadingState)
{
    <div class="weather-loading">
        <div class="weather-loading-icon">⚙️</div>
        <span class="weather-loading-text">Retrieving weather...</span>
    </div>
}
else if (WeatherResult != null)
{
    var weatherData = ParseWeatherResult();
    if (weatherData != null)
    {
        var themeColor = GetThemeColor(weatherData.Conditions);
        var weatherIcon = GetWeatherIcon(weatherData.Conditions);

        <div class="weather-card" style="background-color: @themeColor;">
            <div class="weather-card-content">
                <div class="weather-header">
                    <div class="weather-location-info">
                        <h3 class="weather-city">@Location</h3>
                        <p class="weather-subtitle">Current Weather</p>
                    </div>
                    <div class="weather-icon">
                        @((MarkupString)weatherIcon)
                    </div>
                </div>

                <div class="weather-temperature">
                    <div class="weather-temp-primary">
                        <span>@weatherData.Temperature°C</span>
                        <span class="weather-temp-secondary">
                            / @(((weatherData.Temperature * 9) / 5 + 32).ToString("F1"))°F
                        </span>
                    </div>
                    <div class="weather-conditions">@weatherData.Conditions</div>
                </div>

                <div class="weather-details">
                    <div class="weather-detail-item">
                        <p class="weather-detail-label">Humidity</p>
                        <p class="weather-detail-value">@weatherData.Humidity%</p>
                    </div>
                    <div class="weather-detail-item">
                        <p class="weather-detail-label">Wind</p>
                        <p class="weather-detail-value">@weatherData.WindSpeed km/h</p>
                    </div>
                    <div class="weather-detail-item">
                        <p class="weather-detail-label">Feels Like</p>
                        <p class="weather-detail-value">@weatherData.FeelsLike°</p>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    /// <summary>
    /// Registry component contract: Data object (FunctionCallContent or FunctionResultContent)
    /// </summary>
    [Parameter, EditorRequired]
    public required object Data { get; set; }

    /// <summary>
    /// Registry component contract: Media type identifier
    /// </summary>
    [Parameter]
    public string MediaType { get; set; } = ToolContentMediaTypes.WeatherCall;

    // Determine component state based on Data type - show loading only when we have a call without a result
    private bool IsLoadingState => 
        Data is FunctionCallContent && WeatherResult == null;

    private FunctionCallContent? WeatherCall =>
        Data as FunctionCallContent;

    private FunctionResultContent? WeatherResult
    {
        get
        {
            // If Data is already a result, use it directly
            if (Data is FunctionResultContent result)
            {
                Console.WriteLine($"[WeatherToolComponent.WeatherResult] Data is result: CallId={result.CallId}");
                return result;
            }

            // If Data is a call, look up matching result from ChatMessageItem's static tracking
            if (Data is FunctionCallContent call)
            {
                // Access ChatMessageItem's static result lookup
                // This maintains compatibility with existing call/result correlation logic
                var matchedResult = ChatMessageItem.GetMatchingResult(call.CallId);
                Console.WriteLine($"[WeatherToolComponent.WeatherResult] Lookup for CallId={call.CallId}: Found={matchedResult != null}");
                return matchedResult;
            }

            return null;
        }
    }

    private string Location
    {
        get
        {
            FunctionCallContent? call = WeatherCall;
            
            // If we have a result but no call, look up the matching call
            if (call == null && WeatherResult != null)
            {
                ChatMessageItem.TryGetMatchingCall(WeatherResult.CallId, out call);
            }

            return call != null && TryGetLocation(call.Arguments, out string? location) && !string.IsNullOrWhiteSpace(location)
                ? location
                : "Unknown Location";
        }
    }

    private static bool TryGetLocation(IDictionary<string, object?>? arguments, out string? location)
    {
        location = null;

        if (arguments is null || !arguments.TryGetValue("location", out object? value) || value is null)
        {
            return false;
        }

        if (value is string locationString)
        {
            location = locationString;
            return true;
        }

        if (value is JsonElement locationElement && locationElement.ValueKind == JsonValueKind.String)
        {
            location = locationElement.GetString();
            return !string.IsNullOrWhiteSpace(location);
        }

        return false;
    }

    private sealed class WeatherData
    {
        public int Temperature { get; set; }
        public string Conditions { get; set; } = string.Empty;
        public int Humidity { get; set; }
        public int WindSpeed { get; set; }
        public int FeelsLike { get; set; }
    }

    private WeatherData? ParseWeatherResult()
    {
        if (WeatherResult?.Result is null)
        {
            return null;
        }

        try
        {
            object resultObj = WeatherResult.Result;
            if (resultObj is JsonElement jsonElement)
            {
                return ParseWeatherElement(jsonElement);
            }

            if (resultObj is JsonDocument jsonDocument)
            {
                return ParseWeatherElement(jsonDocument.RootElement);
            }

            string? jsonString = null;
            if (resultObj is byte[] bytes)
            {
                jsonString = Encoding.UTF8.GetString(bytes);
            }
            else if (resultObj is string stringResult)
            {
                jsonString = stringResult;
            }
            else
            {
                jsonString = JsonSerializer.Serialize(resultObj);
            }

            if (!string.IsNullOrWhiteSpace(jsonString))
            {
                using JsonDocument doc = JsonDocument.Parse(jsonString);
                return ParseWeatherElement(doc.RootElement);
            }
        }
        catch (Exception)
        {
            // Fallback on parsing failure
        }

        return null;
    }

    private static WeatherData ParseWeatherElement(JsonElement element)
    {
        return new WeatherData
        {
            Temperature = element.TryGetProperty("temperature", out JsonElement temp) ? temp.GetInt32() : 0,
            Conditions = element.TryGetProperty("conditions", out JsonElement cond) ? cond.GetString() ?? "clear" : "clear",
            Humidity = element.TryGetProperty("humidity", out JsonElement hum) ? hum.GetInt32() : 0,
            WindSpeed = element.TryGetProperty("windSpeed", out JsonElement wind) ? wind.GetInt32() : 0,
            FeelsLike = element.TryGetProperty("feelsLike", out JsonElement feels) ? feels.GetInt32() : 0
        };
    }

    private static string GetThemeColor(string conditions)
    {
        string conditionLower = conditions.ToLowerInvariant();

        if (conditionLower.Contains("clear") || conditionLower.Contains("sunny"))
            return "#667eea";

        if (conditionLower.Contains("rain") || conditionLower.Contains("storm"))
            return "#4A5568";

        if (conditionLower.Contains("cloud"))
            return "#718096";

        if (conditionLower.Contains("snow"))
            return "#63B3ED";

        return "#764ba2";
    }

    private static string GetWeatherIcon(string conditions)
    {
        string conditionLower = conditions.ToLowerInvariant();

        if (conditionLower.Contains("clear") || conditionLower.Contains("sunny"))
        {
            return """
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="weather-icon-svg">
                    <circle cx="12" cy="12" r="5" />
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke-width="2" stroke="currentColor" />
                </svg>
                """;
        }

        if (conditionLower.Contains("rain") || conditionLower.Contains("drizzle") || 
            conditionLower.Contains("snow") || conditionLower.Contains("storm"))
        {
            return """
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="weather-icon-svg">
                    <path d="M7 15a4 4 0 0 1 0-8 5 5 0 0 1 10 0 4 4 0 0 1 0 8H7z" fill="currentColor" opacity="0.8" />
                    <path d="M8 18l2 4M12 18l2 4M16 18l2 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none" />
                </svg>
                """;
        }

        if (conditionLower.Contains("fog") || conditionLower.Contains("cloud") || conditionLower.Contains("overcast"))
        {
            return """
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="weather-icon-svg">
                    <path d="M7 15a4 4 0 0 1 0-8 5 5 0 0 1 10 0 4 4 0 0 1 0 8H7z" fill="currentColor" />
                </svg>
                """;
        }

        // Default cloud icon
        return """
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="weather-icon-svg">
                <path d="M7 15a4 4 0 0 1 0-8 5 5 0 0 1 10 0 4 4 0 0 1 0 8H7z" fill="currentColor" />
            </svg>
            """;
    }
}
