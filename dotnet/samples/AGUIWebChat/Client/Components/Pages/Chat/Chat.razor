@page "/"
@using System.Collections.Generic
@using System.ComponentModel
@using System.Text
@using System.Text.Json
@using Microsoft.Extensions.AI
@using AGUIWebChat.Client.ViewModels
@inject ChatViewModel ViewModel
@inject NavigationManager Nav
@implements IDisposable

<PageTitle>AG-UI Chat</PageTitle>

<ChatHeader OnNewChat="@ResetConversationAsync" />

<div class="chat-layout">
    <div class="chat-transcript">
        <ChatMessageList Messages="@ViewModel.Messages" InProgressMessage="@ViewModel.CurrentResponseMessage">
            <NoMessagesContent>
                <div>Ask the assistant a question to start a conversation.</div>
            </NoMessagesContent>
            <SupplementalContent>
                @if (ViewModel.PlanSteps.Count > 0)
                {
                    <ChatPlanMessage Steps="@ViewModel.PlanSteps" />
                }
            </SupplementalContent>
        </ChatMessageList>
        <div class="chat-container">
            <ChatSuggestions OnSelected="@AddUserMessageAsync" @ref="@chatSuggestions" />
            <ChatInput OnSend="@AddUserMessageAsync" @ref="@chatInput" />
        </div>
    </div>
</div>

@code {
    private ChatInput? chatInput;
    private ChatSuggestions? chatSuggestions;

    protected override void OnInitialized()
    {
        ViewModel.MessagesChanged += OnMessagesChanged;
    }

    private void OnMessagesChanged(object? sender, EventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task AddUserMessageAsync(ChatMessage userMessage)
    {
        // UI Logic: Clear suggestions and focus input
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();

        // Delegate logic to ViewModel
        if (!string.IsNullOrWhiteSpace(userMessage.Text))
        {
            await ViewModel.SendMessageAsync(userMessage.Text);
        }

        // Post-processing UI logic
        chatSuggestions?.Update(ViewModel.Messages);
    }

    private async Task ResetConversationAsync()
    {
        ViewModel.ResetConversation();
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();
    }

    public void Dispose()
    {
        ViewModel.MessagesChanged -= OnMessagesChanged;
        ViewModel.CancelAnyCurrentResponse();
    }
}
