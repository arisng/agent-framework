@using System.Runtime.CompilerServices
@using System.Text
@using System.Text.Json
@using System.Text.RegularExpressions
@using System.Linq

@if (Message.Role == ChatRole.User)
{
    <div class="user-message">
        @Message.Text
    </div>
}
else if (Message.Role == ChatRole.Assistant || Message.Role == ChatRole.System)
{
    foreach (var content in Message.Contents)
    {
        if (Message.Role == ChatRole.Assistant && content is TextContent { Text: { Length: > 0 } text })
        {
            <div class="assistant-message">
                <div>
                    <div class="assistant-message-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
                        </svg>
                    </div>
                </div>
                <div class="assistant-message-header">Assistant</div>
                <div class="assistant-message-text">
                    <div>@((MarkupString)text)</div>
                </div>
            </div>
        }
        else if (content is DataContent dataContent)
        {
            var stateText = FormatDataContent(dataContent);
            if (!string.IsNullOrWhiteSpace(stateText))
            {
                <div class="assistant-message assistant-state">
                    <div>
                        <div class="assistant-message-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 6.75h15m-15 4.5h15m-15 4.5h15" />
                            </svg>
                        </div>
                    </div>
                    <div class="assistant-message-header">State Update</div>
                    <div class="assistant-message-text">
                        <div><strong>Media type:</strong> @(dataContent.MediaType ?? "application/octet-stream")</div>
                        <pre>@stateText</pre>
                    </div>
                </div>
            }
        }
        else if (Message.Role == ChatRole.Assistant && content is FunctionCallContent { Name: "Search" } fcc && fcc.Arguments?.TryGetValue("searchPhrase", out var searchPhrase) is true)
        {
            <div class="assistant-search">
                <div class="assistant-search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </div>
                <div class="assistant-search-content">
                    Searching:
                    <span class="assistant-search-phrase">@searchPhrase</span>
                    @if (fcc.Arguments?.TryGetValue("filenameFilter", out var filenameObj) is true && filenameObj is string filename && !string.IsNullOrEmpty(filename))
                    {
                        <text> in </text><span class="assistant-search-phrase">@filename</span>
                    }
                </div>
            </div>
        }
    }
}

@code {
    private static readonly ConditionalWeakTable<ChatMessage, ChatMessageItem> SubscribersLookup = new();
    private static readonly Regex Base64Regex = new("^[A-Za-z0-9+/]*={0,2}$", RegexOptions.Compiled);

    [Parameter, EditorRequired]
    public required ChatMessage Message { get; set; }

    [Parameter]
    public bool InProgress { get; set;}

    protected override void OnInitialized()
    {
        SubscribersLookup.AddOrUpdate(Message, this);
    }

    public static void NotifyChanged(ChatMessage source)
    {
        if (SubscribersLookup.TryGetValue(source, out var subscriber))
        {
            subscriber.StateHasChanged();
        }
    }

    private static string FormatDataContent(DataContent dataContent)
    {
        string raw = GetDataContentText(dataContent);
        if (string.IsNullOrWhiteSpace(raw))
        {
            return string.Empty;
        }

        if (dataContent.MediaType?.Contains("json", StringComparison.OrdinalIgnoreCase) == true)
        {
            try
            {
                using JsonDocument document = JsonDocument.Parse(raw);
                return JsonSerializer.Serialize(document.RootElement, new JsonSerializerOptions { WriteIndented = true });
            }
            catch (JsonException)
            {
                return raw;
            }
        }

        return raw;
    }

    private static string GetDataContentText(DataContent dataContent)
    {
        string raw = dataContent.Base64Data.ToString();
        if (string.IsNullOrWhiteSpace(raw) && dataContent.Uri is not null)
        {
            return dataContent.Uri.ToString();
        }

        if (IsLikelyBase64(raw))
        {
            try
            {
                return Encoding.UTF8.GetString(Convert.FromBase64String(raw));
            }
            catch (FormatException)
            {
                return raw;
            }
        }

        return raw;
    }

    private static bool IsLikelyBase64(string value)
    {
        return !string.IsNullOrWhiteSpace(value)
            && value.Length % 4 == 0
            && Base64Regex.IsMatch(value);
    }
}
